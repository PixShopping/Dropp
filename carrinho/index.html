<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> MVoutlet | Carrinho </title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="../global.css">
    <link rel="shortcut icon" href="../src/img/favicon.png" type="image/x-icon">
</head>

<body>
    
    <!-- ANUNCIO -->
    <div class="anuncio">
        <ion-icon name="bicycle-outline"></ion-icon>
        <p>Frete grátis em todo o Brasil</p>
    </div>
    
    <!-- NAVGATION -->
    <header class="navgation">

        <ion-icon onclick="abrirMenu()" class="btn-menu" id="openMenu" name="menu"></ion-icon>
        <ion-icon onclick="fecharMenu()" class="btn-menu" id="closeMenu" name="close"></ion-icon>

        <img id="logo" src="../src/img/logo.png">

        <div class="flex pesquisa">
            <input onkeydown="pressionarEnter(event, 'buscar')" placeholder="O que está buscando?" type="text" id="buscar">
            <ion-icon onclick="pesquisar('buscar')" name="search"></ion-icon>
        </div>

        <div class="pesquisaMobile">
            <input onkeydown="pressionarEnter(event, 'buscarMobile')" placeholder="O que está buscando?" type="text" id="buscarMobile">
            <ion-icon onclick="pesquisar('buscarMobile')" name="search"></ion-icon>
        </div>

        <div class="flex buttons">
            <ion-icon onclick="abrirURL('rastreio/')" name="location-outline"></ion-icon>
            <ion-icon onclick="abrirURL('carrinho/')" name="cart-outline"></ion-icon>
        </div>

    </header>


    <!-- LINKS -->
    <nav class="links">
        <ul>
            <div class="triangulo"></div>
            <li>
                <a href="../index.html">home</a>
            </li>
            <li>
                <a href="../produtos/">produtos</a>
            </li>
            <li>
                <a href="../index.html#sobre">sobre nós</a>
            </li>
            <li>
                <a href="../rastreio/">rastrear pedido</a>
            </li>
        </ul>
    </nav>

    <!-- POPUP DE CADASTRO -->
    <article id="popupContent" class="cadastro">

        <div class="navbar">
            <h1>Logar</h1>
            <ion-icon onclick="fecharPopup('cadastro')" name="close"></ion-icon>
        </div>
        
        <div class="flex">

            <section class="left">

                <img src="../src/img/logar.png">
    
            </section>
    
            <section class="right">
    
                <h1>Fazer login</h1>
                <p>Faça o login agora para acessar conteúdo exclusivo e personalizado. Sua jornada está apenas a um clique de distância. Vamos lá, sua experiência está esperando por você!</p>
    
                <div class="column">
                    <label id="alertaEmail" for="email">Email <strong>*</strong></label>
                    <input placeholder="ex: Murilo123@gmail.com" id="email" type="text">
                </div>
                
                <div class="column">
                    <label id="alertaSenha" for="senha">Senha <strong>*</strong></label>
                    <input placeholder="ex: Senha123#" id="senha" type="text">
                    <ion-icon style="display: none;" id="esconder" onclick="mostrarSenha()" name="eye-off"></ion-icon>
                    <ion-icon id="mostrar" onclick="esconderSenha()" name="eye"></ion-icon>
                </div>

                <button onclick="logar()" class="btn-comprar">Escrever-se</button>
                <p class="a-logar">Não possui cadastro? <a onclick="mudarPopupCadastro()">Cadastrar</a></p>

            </section>

        </div>
        
    </article>

    <main class="container">

        <div class="flex">
            <h1 id="logado">Meu carrinho</h1>
            <button onclick="sairDaConta()" class="botaoSair">Sair da Conta</button>
        </div>
        
        <section class="compras">



        </section>

        <section class="carrinho">



        </section>

        <h3 id="totalEconomizado"></h3>


    </main>

    <!-- CONTATO -->
    <footer class="contato">
        <article>    
                        
            <section class="assine">
                <h1>MVoutlet</h1>
                <p>Assine já nosso plano VIP para garantir recompensas e cupons para nossa loja.</p>
                <input placeholder="Seu E-mail" type="text">
                <button>Enviar</button>
            </section>

            <section class="suporte">
                <h1>Suporte ao Cliente</h1>
                <li>
                    <p><strong>Email</strong>: MVoutlet@MVoutlet.com.br</p>
                </li>
                <li>
                    <p><strong>Whatsapp</strong>: +55 (16) 997569308</p>
                </li>
                <li>
                    <p><strong>Telefone</strong>: (16) 3324-1234</p>
                </li>
                <li>
                    <p><strong>Instagram</strong>: @mvoutlet.br</p>
                </li>
                <li>
                    <p><strong>Facebook</strong>: MVoutlet_</p>
                </li>
            </section>

        </article>

        <div class="linha"></div>

        <section class="direitos">
            
            <div class="flex">
                <ion-icon onclick="abrirURL('https://instagram.com/mvoutlet.br')" name="logo-instagram"></ion-icon>
                <ion-icon onclick="abrirURL('https://facebook.com/MVoutlet_')" name="logo-facebook"></ion-icon>
                <ion-icon onclick="abrirURL('https://wa.me/5516997569308')" name="logo-whatsapp"></ion-icon>
            </div>

            <p>© MVoutlet 2023</p>

            <div class="flex">
                <ion-icon name="logo-javascript"></ion-icon>
                <ion-icon name="logo-firebase"></ion-icon>
            </div>
        
        </section>
    </footer>

</body>

    <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-storage-compat.js"></script>
    <!-- JAVASCRIPT -->
    <script>


        // BANCO DE DADOS
        const firebaseConfig = {
            apiKey: "AIzaSyBqbDhvZYwoJng6u2AF-YHTBBCPWiYAnuY",
            authDomain: "dropp-71540.firebaseapp.com",
            projectId: "dropp-71540",
            storageBucket: "dropp-71540.appspot.com",
            messagingSenderId: "226605796065",
            appId: "1:226605796065:web:7b6a8652ed1e93d78f45a0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const loja = 'teste';

        // VERIFICAR SE ESTA LOGADO
        const logado = document.getElementById('logado');
        const botoes = document.querySelector('.buttons');
        const botaoSair = document.querySelector('.botaoSair');
        const email = localStorage.getItem('email');
        const senha = localStorage.getItem('senha');
        const popupCadastro = document.querySelector('.cadastro');
        const container = document.querySelector('.container');
        if (!email && !senha) {
            popupCadastro.style.display = "flex";
            container.style.display = "none";
            setTimeout(() => {
                popupCadastro.style.opacity = "1";
            }, 500);
        } else {
            logado.innerHTML = `Carrinho de ${email}`;
            botaoSair.style.display = "flex";
        }


        function mudarPopupLogar() {
            const popup = document.getElementById('popupContent');
            popup.innerHTML = `
                <div class="navbar">
                <h1>Logar</h1>
                <ion-icon onclick="fecharPopup('cadastro')" name="close"></ion-icon>
            </div>
            
            <div class="flex">

                <section class="left">

                    <img src="../src/img/logar.png">
        
                </section>
        
                <section class="right">
        
                    <h1>Fazer login</h1>
                    <p>Faça o login agora para acessar conteúdo exclusivo e personalizado. Sua jornada está apenas a um clique de distância. Vamos lá, sua experiência está esperando por você!</p>
        
                    <div class="column">
                        <label id="alertaEmail" for="email">Email <strong>*</strong></label>
                        <input placeholder="ex: Murilo123@gmail.com" id="email" type="text">
                    </div>
                    
                    <div class="column">
                        <label id="alertaSenha" for="senha">Senha <strong>*</strong></label>
                        <input placeholder="ex: Senha123#" id="senha" type="text">
                        <ion-icon style="display: none;" id="esconder" onclick="mostrarSenha()" name="eye-off"></ion-icon>
                        <ion-icon id="mostrar" onclick="esconderSenha()" name="eye"></ion-icon>
                    </div>

                    <button onclick="logar()" class="btn-comprar">Escrever-se</button>
                    <p class="a-logar">Não possui cadastro? <a onclick="mudarPopupCadastro()">Cadastrar</a></p>

                </section>

            </div>
            `;
        }

        function mudarPopupCadastro() {
            const popup = document.getElementById('popupContent');
            popup.innerHTML = `
                <div class="navbar">
                <h1>Cadastre-se</h1>
                <ion-icon onclick="fecharPopup('cadastro')" name="close"></ion-icon>
            </div>
            
            <div id="popupContent" class="flex">

                <section class="left">

                    <img src="../src/img/cadastro.gif">
        
                </section>
        
                <section class="right">
        
                    <h1>Fazer cadastro</h1>
                    <p>Escreva-se em nossa loja para ter acesso ao seu próprio carrinho, realizar compras e ser o primeiro a saber das nossas novidades, eventos e ofertas especiais em nosso site.</p>
        
                    <div class="column">
                        <label id="alertaNome" for="nome">Nome <strong>*</strong></label>
                        <input placeholder="ex: Murilo Nepomuceno" id="nome" type="text">
                    </div>

                    <div class="column">
                        <label id="alertaEmail" for="email">Email <strong>*</strong></label>
                        <input placeholder="ex: Murilo123@gmail.com" id="email" type="text">
                    </div>
                    
                    <div class="column">
                        <label id="alertaSenha" for="senha">Senha <strong>*</strong></label>
                        <input placeholder="ex: Senha123#" id="senha" type="text">
                        <ion-icon style="display: none;" id="esconder" onclick="mostrarSenha()" name="eye-off"></ion-icon>
                        <ion-icon id="mostrar" onclick="esconderSenha()" name="eye"></ion-icon>
                    </div>

                    <button onclick="cadastrar()" class="btn-comprar">Escrever-se</button>
                    <p class="a-logar">Ja possui conta? <a onclick="mudarPopupLogar()">Logar</a></p>

                </section>

            </div>
            `;
        }

        // BOTAO DO MENU
        function abrirMenu() {
            const openMenu = document.getElementById('openMenu');
            const closeMenu = document.getElementById('closeMenu');
            openMenu.style.display = "none";
            closeMenu.style.display = "flex";

            const menu = document.querySelector('.links ul');
            menu.style.display = "flex";
            setTimeout(() => {
                menu.style.opacity = 1;
            }, 200);
        }

        function fecharMenu() {
            const openMenu = document.getElementById('openMenu');
            const closeMenu = document.getElementById('closeMenu');
            openMenu.style.display = "flex";
            closeMenu.style.display = "none";

            const menu = document.querySelector('.links ul');
            menu.style.opacity = 0;
            
            setTimeout(() => {
                menu.style.display = "none";
            }, 200);
        }

        async function fecharPopup(classe) {
            const div = document.querySelector(`.${classe}`);
            container.style.display = "flex";
            div.style.opacity = "0";
            setTimeout(() => {
                div.style.display = "none";
            }, 500);
        }

        /* Mostrar Senha */
        function mostrarSenha() {
            const senha = document.getElementById('senha');
            senha.type = 'text';    
            const mostrar = document.getElementById('mostrar');
            const esconder = document.getElementById('esconder');
            mostrar.style.display = "flex";
            esconder.style.display = "none";
        }


        /* Esconder Senha */
        function esconderSenha() {
            const senha = document.getElementById('senha');
            senha.type = 'password';
            const mostrar = document.getElementById('mostrar');
            const esconder = document.getElementById('esconder');
            mostrar.style.display = "none";
            esconder.style.display = "flex";
        }

        // Remover do carrinho
        async function removerCarrinho(nome) {
            await db.collection('usuarios')
            .doc(email).collection('carrinho')
            .doc(nome).delete().then((response) => {
                window.location.reload();
            })
        }

        async function sairDaConta() {
            await localStorage.clear();
            await window.location.reload();
        }


        
        carregarLoja();
        async function carregarLoja() {
            const root = document.documentElement;
            const carrinho = document.querySelector('.carrinho');
            const compras = document.querySelector('.compras');
            const container = document.querySelector('.container');

            const h1economizado = document.getElementById('totalEconomizado');
            var totalEconomizado = 0;
            if (email && senha) {
                await db.collection('usuarios')
                .doc(email)
                .collection('carrinho')
                .onSnapshot((data) => {
                    const tamanho = data.size;
                    if (tamanho > 0) {
                        data.docs.map((val) => {
                            const produto = val.id;
                            db.collection('produtos')
                            .doc(produto)
                            .get().then((doc) => {
                                const imagem = doc.data().imagem;
                                const precoNovo = doc.data().precoNovo;
                                const precoAntigo = doc.data().precoAntigo;
                                var porcentagem = parseFloat(precoNovo.replace(",", ".")) / parseFloat(precoAntigo.replace(",", "."));
                                totalEconomizado += parseFloat(precoAntigo.replace(",", ".")) - parseFloat(precoNovo.replace(",", "."));
                                porcentagem *= 100;
                                porcentagem = porcentagem.toFixed(2);
                                porcentagem -= 100 // Arredonda para duas casas decimais
                                porcentagem = porcentagem.toFixed(2);
                                porcentagem = Math.abs(porcentagem);
                                porcentagem = porcentagem + "%";
                                const storageRef = storage.ref().child(`produtos/${produto}/${imagem}`);
                                storageRef.getDownloadURL().then( function(url) {
                                    carrinho.innerHTML += `
                                        <div class="produto">
                                            <div class="porcentagem">
                                                <ion-icon name="arrow-down"></ion-icon>
                                                <a>${porcentagem}</a>    
                                            </div>
                                            <img src="${url}">
                                            <div class="produtoMobile">
                                                <h1>${produto}</h1>
                                                <h2>R$${precoNovo} <span>R$${precoAntigo}</span></h2>
                                                <button class="btn-comprar" onclick="removerCarrinho('${produto}')">Remover do carrinho</button>
                                            </div>
                                            
                                        </div>
                                    `;
                                });
                                totalEconomizado = totalEconomizado.toFixed(2);
                                h1economizado.innerHTML = `Total economizado: ${totalEconomizado} Reais`;
                            });
                        });
                    } else {
                        carrinho.innerHTML = `
                            <div class="column">
                                <ion-icon class="cart" name="cart-outline"></ion-icon>
                                <h4>Seu carrinho esta vazio</h4>
                                <button onclick="abrirURL('produtos')" class="btn-comprar">Ver nossos produtos</button>
                            </div>
                        `;
                    }
                });

                await db.collection('usuarios')
                .doc(email)
                .collection('compras')
                .onSnapshot((data) => {
                    const existe = data;
                    if (existe) {
                        data.docs.map((val) => {
                            const produto = val.id;
                            const status = val.data().status;
                            const cor = val.data().cor;
                            db.collection('produtos')
                            .doc(produto)
                            .get().then((doc) => {
                                const imagem = doc.data().imagem;
                                const preco = doc.data().precoNovo;
                                const storageRef = storage.ref().child(`produtos/${produto}/${imagem}`);
                                storageRef.getDownloadURL().then( function(url) {
                                    compras.innerHTML += `
                                        <div class="produto">
                                            <img src="${url}">
                                            <div class="produtoMobile">
                                                <h1>${produto}</h1>
                                                <h2>R$${preco}</h2>
                                                <h3 style="background: ${cor};" class="status">${status}</h3>
                                            </div>
                                        </div>
                                    `;
                                });
                            });
                        });
                    }
                });
                
            } else {
                container.innerHTML = `
                    <ion-icon class="cart" name="cart-outline"></ion-icon>
                    <h4>Seu carrinho esta vazio</h4>
                    <button onclick="abrirURL('produtos')" class="btn-comprar">Ver nossos produtos</button>
                `;
            }

            
            
        }


        function tirarEspaco(val) {
            var resultado = val;
            resultado = resultado.replace(/\s+/g, ' ');
            resultado = resultado.trim();
            return resultado;
        }
        
        // LOGAR
        async function logar() {
            const emailValue = document.getElementById('email').value;
            const email = tirarEspaco(emailValue);
            const alertaEmail = document.getElementById('alertaEmail');
            const senha = document.getElementById('senha').value;
            const alertaSenha = document.getElementById('alertaSenha');
            const cadastro = document.querySelector('.cadastro .flex');
            const h1 = document.querySelector('.cadastro .navbar h1');
            if (email) {
                alertaEmail.innerHTML = `Email`;
                if (senha) {
                    alertaSenha.innerHTML = `Senha`;
                    await db.collection('usuarios')
                    .doc(email).get().then((doc) => {
                        const usuario = doc.data();
                        if (usuario) {
                            const senhaBancoDeDados = doc.data().senha;
                            if (senha == senhaBancoDeDados) {
                                localStorage.setItem('email', email);
                                localStorage.setItem('senha', senha);
                                window.location.href = "#"
                                cadastro.style.flexDirection = "column";
                                cadastro.style.alignItems = "center";
                                cadastro.innerHTML = `
                                    <img style="margin: 0px 0px 0px -60px;" src="../src/img/cartao.gif" type="image/gif">
                                    <h1 class="obrigado">Agora você esta pronto para comprar os melhores produtos do Brasil</h1>
                                `;
                                h1.innerHTML = "Login feito com sucesso";
                                setTimeout(() => {
                                    window.location.href = "../carrinho/";
                                }, 2500);
                            } else {
                                alertaSenha.innerHTML = `Senha: <strong>Senha incorreta</strong>`;
                            }
                        } else {
                            alertaEmail.innerHTML = `Email: <strong>Usuario não existe</strong>`;
                        }
                    })
                } else {
                    alertaSenha.innerHTML = `Senha: <strong>Digite uma senha</strong>`;
                }
            } else {
                alertaEmail.innerHTML = `Email: <strong>Email invalido</strong>`;
            }
        }



        // CADASTRAR
        async function cadastrar() {
            const nome = document.getElementById('nome').value;
            const alertaNome = document.getElementById('alertaNome');
            const email = document.getElementById('email').value;
            const alertaEmail = document.getElementById('alertaEmail');
            const senha = document.getElementById('senha').value;
            const alertaSenha = document.getElementById('alertaSenha');
            const cadastro = document.querySelector('.cadastro .flex');
            const h1 = document.querySelector('.cadastro .navbar h1');
            if (nome) {
                alertaNome.innerHTML = `Nome`;
                if (validarEmail(email)) {
                    alertaEmail.innerHTML = `Email`;
                    await db.collection('usuarios')
                    .doc(email).get().then((doc) => {
                        const usuario = doc.data();
                        if (!usuario) {
                            if (senha) {
                                alertaSenha.innerHTML = `Senha`;
                                db.collection('usuarios')
                                .doc(email).set({
                                    nome: nome,
                                    email: email,
                                    senha: senha
                                }).then((response) => {
                                    localStorage.setItem('email', email);
                                    localStorage.setItem('senha', senha);
                                    window.location.href = "#"
                                    cadastro.style.flexDirection = "column";
                                    cadastro.style.alignItems = "center";
                                    cadastro.innerHTML = `
                                        <img style="margin: 0px 0px 0px -60px;" src="../src/img/cartao.gif" type="image/gif">
                                        <h1 class="obrigado">Agora você esta pronto para comprar os melhores produtos do Brasil</h1>
                                    `;
                                    h1.innerHTML = "Cadastro feito com sucesso";
                                    setTimeout(() => {
                                        window.location.href = "../carrinho/";
                                    }, 2500);
                                });
                            } else {
                                alertaSenha.innerHTML = `Senha: <strong>Digite uma senha</strong>`;
                            }
                        } else {
                            alertaEmail.innerHTML = `Email: <strong>Email já existente</strong>`;
                        }
                    });
                } else {
                    alertaEmail.innerHTML = `Email: <strong>Email invalido</strong>`;
                }    
            } else {
                alertaNome.innerHTML = `Nome: <strong>Digite um nome</strong>`;
            }
        }

        function validarEmail(email) {
            // Expressão regular para validar o formato do e-mail
            const regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{3}$/;

            // Testa se o e-mail corresponde ao padrão
            if (regex.test(email)) {
                console.log(`O e-mail ${email} é válido.`);
                return true;
            } else {
                console.log(`O e-mail ${email} é inválido.`);
                return false;
            }
        }



        function abrirURL(url) {
            window.location.href = `../${url}`;
        }

        /* Metodo de busca */
        async function pesquisar(id) {
            const buscar = await document.getElementById(id).value.toLowerCase().replace(/\s/g, '');
            window.location.href = "../produtos/?search=" + encodeURIComponent(buscar);
        }

        /* Adicionando evento de click do teclado */
        function pressionarEnter(event, id) {
            if (event.key === "Enter") {
                pesquisar(id);
            }
        }

    </script>

<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

</html>