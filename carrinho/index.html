<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Mvshop | Carrinho </title>
    <link rel="stylesheet" href="./style.css">
    <link rel="shortcut icon" href="https://firebasestorage.googleapis.com/v0/b/dropp-71540.appspot.com/o/teste%2Fnavgation%2Ffavicon.png?alt=media&token=041e70f9-b847-4789-8098-8ce417a2c02c" type="image/x-icon">
</head>

<body>
    
    <div class="anuncio">

    </div>
    
    <header class="navgation">
    </header>

    <nav class="links">
        <ul>
            <div class="triangulo"></div>
        </ul>
    </nav>

    <main class="container">

        <h1>Meu carrinho</h1>

        <section class="carrinho">



        </section>
        
        <h3 id="totalEconomizado"></h3>

        <button class="btn-comprar">Comprar</button>
        <button onclick="abrirURL('produtos')" class="btn-addCarrinho">Continuar comprando</button>

    </main>

    <footer class="contato">

    </footer>

</body>

    <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-storage-compat.js"></script>
    <!-- JAVASCRIPT -->
    <script>


        // BANCO DE DADOS
        const firebaseConfig = {
            apiKey: "AIzaSyBqbDhvZYwoJng6u2AF-YHTBBCPWiYAnuY",
            authDomain: "dropp-71540.firebaseapp.com",
            projectId: "dropp-71540",
            storageBucket: "dropp-71540.appspot.com",
            messagingSenderId: "226605796065",
            appId: "1:226605796065:web:7b6a8652ed1e93d78f45a0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const loja = 'teste';

        // BOTAO DO MENU
        function abrirMenu() {
            const openMenu = document.getElementById('openMenu');
            const closeMenu = document.getElementById('closeMenu');
            openMenu.style.display = "none";
            closeMenu.style.display = "flex";

            const menu = document.querySelector('.links ul');
            menu.style.display = "flex";
            setTimeout(() => {
                menu.style.opacity = 1;
            }, 200);
        }

        function fecharMenu() {
            const openMenu = document.getElementById('openMenu');
            const closeMenu = document.getElementById('closeMenu');
            openMenu.style.display = "flex";
            closeMenu.style.display = "none";

            const menu = document.querySelector('.links ul');
            menu.style.opacity = 0;
            
            setTimeout(() => {
                menu.style.display = "none";
            }, 200);
        }


        // Remover do carrinho
        async function removerCarrinho(nome) {
            await localStorage.removeItem(`produto-${nome}`);
            await window.location.reload();
        }
        
        carregarLoja();
        async function carregarLoja() {
            const root = document.documentElement;
            const navgation = document.querySelector('.navgation');
            const links = document.querySelector('.links ul');
            const contato = document.querySelector('.contato');
            const anuncio = document.querySelector('.anuncio');
            const carrinho = document.querySelector('.carrinho');
            const container = document.querySelector('.container');

            await db.collection(loja)
            .doc('navgation')
            .collection('anuncio').onSnapshot((data) => {
                data.docs.map((val) => {
                    const texto = val.data().texto;
                    anuncio.innerHTML = `
                        <ion-icon name="bicycle-outline"></ion-icon>
                        <p>${texto}</p>
                    `;
                });
            });

            await db.collection(loja)
            .doc('cores').get().then((doc) => {
                const corPrincipal = doc.data().principal;
                const corBackground = doc.data().background;
                const corTexto = doc.data().text;
                const vermelho = doc.data().vermelho;
                const verde = doc.data().verde;
                root.style.setProperty('--background', corBackground);
                root.style.setProperty('--text', corTexto);
                root.style.setProperty('--principal', corPrincipal);
                root.style.setProperty('--verde', verde);
                root.style.setProperty('--vermelho', vermelho);
            });

            await db.collection(loja)
            .doc('navgation')
            .get().then((doc) => {

                // VERIFICA SE EXISTE NAVGATION
                if (doc.data()) {
                    const logo = doc.data().logo;
                    const storageRef = storage.ref().child(`${loja}/navgation/${logo}`);
                    storageRef.getDownloadURL().then(function (url) {
                        // Use a URL da imagem, por exemplo, para exibi-la
                        navgation.innerHTML = `
                                <ion-icon onclick="abrirMenu()" class="btn-menu" id="openMenu" name="menu"></ion-icon>
                                <ion-icon onclick="fecharMenu()" class="btn-menu" id="closeMenu" name="close"></ion-icon>

                                <img src="${url}">

                                <div class="flex pesquisa">
                                    <input onkeydown="pressionarEnter(event, 'buscar')" placeholder="O que está buscando?" type="text" id="buscar">
                                    <ion-icon onclick="pesquisar('buscar')" name="search"></ion-icon>
                                </div>

                                <div class="pesquisaMobile">
                                    <input onkeydown="pressionarEnter(event, 'buscarMobile')" placeholder="O que está buscando?" type="text" id="buscarMobile">
                                    <ion-icon onclick="pesquisar('buscarMobile')" name="search"></ion-icon>
                                </div>

                                <div class="flex buttons">
                                    <ion-icon onclick="abrirURL('../rastreio/')" name="location-outline"></ion-icon>
                                    <ion-icon onclick="abrirURL('../carrinho/')" name="cart-outline"></ion-icon>
                                </div>
                        `;    
                    });
                }
            });
            
            // ADICIONAR PAGINAS A NAVGATION
            await db.collection(loja)
            .doc('navgation')
            .collection('paginas')
            .orderBy('id', 'asc')
            .get().then((snapshot) => {
                snapshot.forEach((doc) => {
                    if (doc.id) {
                        const pagina = doc.id;
                        const url = doc.data().pagina;
                        links.innerHTML += `
                            <li>
                                <a href="../${url}">${pagina}</a>
                            </li>    
                        `;   
                    }
                });
            });

            // CONTATOS
            await db.collection(loja)
            .doc('contato')
            .get().then((doc) => {
                const email = doc.data().email;
                const telefone = doc.data().telefone;
                const whatsapp = doc.data().whatsapp;
                const whatsappURL = doc.data().whatsappURL;
                const instagram = doc.data().instagram;
                const instagramURL = doc.data().instagramURL;
                const facebook = doc.data().facebook;
                const facebookURL = doc.data().facebookURL;
                const empresa = doc.data().empresa;
                const recado = doc.data().recado;
                contato.innerHTML = `
                    <article>    
                        
                        <section class="assine">
                            <h1>${empresa}</h1>
                            <p>${recado}</p>
                            <input placeholder="Seu E-mail" type="text">
                            <button>Enviar</button>
                        </section>

                        <section class="suporte">
                            <h1>Suporte ao Cliente</h1>
                            <li>
                                <p><strong>Email</strong>: ${email}</p>
                            </li>
                            <li>
                                <p><strong>Whatsapp</strong>: ${whatsapp}</p>
                            </li>
                            <li>
                                <p><strong>Telefone</strong>: ${telefone}</p>
                            </li>
                            <li>
                                <p><strong>Instagram</strong>: ${instagram}</p>
                            </li>
                            <li>
                                <p><strong>Facebook</strong>: ${facebook}</p>
                            </li>
                        </section>

                    </article>

                    <div class="linha"></div>

                    <section class="direitos">
                        
                        <div class="flex">
                            <ion-icon onclick="abrirURL('${instagramURL}')" name="logo-instagram"></ion-icon>
                            <ion-icon onclick="abrirURL('${facebookURL}')" name="logo-facebook"></ion-icon>
                            <ion-icon onclick="abrirURL('${whatsappURL}')" name="logo-whatsapp"></ion-icon>
                        </div>

                        <p>© Mvshop 2023</p>

                        <div class="flex">
                            <ion-icon name="logo-javascript"></ion-icon>
                            <ion-icon name="logo-firebase"></ion-icon>
                        </div>
                    
                    </section>
                `;

            });

            const h1economizado = document.getElementById('totalEconomizado');
            var totalEconomizado = 0;
            if (localStorage.length > 0) {
                for (let i = 0; i < localStorage.length; i++) {
                    // Obtenha a chave (nome do item)
                    let chave = localStorage.key(i);
                    let valor = localStorage.getItem(chave);

                    // PRODUTO : NOME DO PRODUTO
                    await db.collection(loja)
                    .doc('container')
                    .collection('produtos')
                    .doc(valor).get().then((doc) => {
                        const nome = doc.id;
                        const imagem = doc.data().imagem;
                        const precoNovo = doc.data().precoNovo;
                        const precoAntigo = doc.data().precoAntigo;
                        var porcentagem = parseFloat(precoNovo.replace(",", ".")) / parseFloat(precoAntigo.replace(",", "."));
                        totalEconomizado += parseFloat(precoAntigo.replace(",", ".")) - parseFloat(precoNovo.replace(",", "."));
                        porcentagem *= 100;
                        porcentagem = porcentagem.toFixed(2);
                        porcentagem -= 100 // Arredonda para duas casas decimais
                        porcentagem = porcentagem.toFixed(2);
                        porcentagem = Math.abs(porcentagem);
                        porcentagem = porcentagem + "%";
                        const storageRef = storage.ref().child(`${loja}/container/produtos/${imagem}`);
                        storageRef.getDownloadURL().then( function(url) {
                            carrinho.innerHTML += `
                                <div class="produto">
                                    <div class="porcentagem">
                                        <ion-icon name="arrow-down"></ion-icon>
                                        <a>${porcentagem}</a>    
                                    </div>
                                    <img src="${url}">
                                    <div class="produtoMobile">
                                        <h1>${nome}</h1>
                                        <h2>R$${precoNovo} <span>R$${precoAntigo}</span></h2>
                                        <button class="btn-comprar" onclick="removerCarrinho('${nome}')">Remover do carrinho</button>
                                    </div>
                                    
                                </div>
                            `;
                        });
                        container.style.display = "flex";
                    });    
                totalEconomizado = totalEconomizado.toFixed(2);
                h1economizado.innerHTML = `Total economizado: ${totalEconomizado} Reais`;                
                }
            } else {
                container.innerHTML = `
                    <ion-icon class="cart" name="cart-outline"></ion-icon>
                    <h4>Seu carrinho esta vazio</h4>
                    <button onclick="abrirURL('produtos')" class="btn-comprar">Ver nossos produtos</button>
                `;
                container.style.display = "flex";
            }
        }

        function abrirURL(url) {
            window.location.href = `../${url}`;
        }

        /* Metodo de busca */
        async function pesquisar(id) {
            const buscar = await document.getElementById(id).value.toLowerCase().replace(/\s/g, '');
            window.location.href = "../produtos/?search=" + encodeURIComponent(buscar);
        }

        /* Adicionando evento de click do teclado */
        function pressionarEnter(event, id) {
            if (event.key === "Enter") {
                pesquisar(id);
            }
        }

    </script>

<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

</html>