<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Mvoutlet | Pagamento </title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="../global.css">
    <link rel="shortcut icon" href="../src/img/favicon.png" type="image/x-icon">
</head>

<body>
    
    <header class="navgation">

        <img src="../src/img/logoPagamento.png">

        <div class="seguro">
            <div class="flex">
                <p>Compra 100% Segura üîí</p>
            </div>
            <div class="flex">
                <p>Garantia de 30 Dias direto em <strong onclick="abrirURL('index.html')">Nossa Loja</strong></p>
            </div>    
        </div>

    </header>

    <main class="container">

        <article class="produto">



        </article>


        <!-- IDENTIFICA√á√ÉO -->
        <section class="formulario identificacao">

            <div class="progresso">
                <div class="column">
                    <a class="selecionadoFundo">1</a>
                    <p class="selecionadoCor">Informa√ß√µes <br> pessoais</p>
                </div>
                <div class="column">
                    <a>2</a>
                    <p>Entrega</p>
                </div>
                <div class="column">
                    <a>3</a>
                    <p>Pagamento</p>
                </div>
            </div>

            <!-- Fomulario de identifica√ß√£o -->
            <article class="form">

                <h1><span>1</span>Identifique-se</h1>

                <label for="nome">Nome Completo <strong for="nome">*</strong></label>
                <input onblur="validarInput('nome')" id="nome" placeholder="ex: Vitor Custodio da Silva" type="text">

                <label for="email">E-mail <strong for="email">*</strong></label>
                <input onblur="validarInput('email')" id="email" placeholder="ex: vitor@gmail.com" type="text">

                <label for="cpf">CPF <strong for="cpf">*</strong></label>
                <input onblur="validarInput('cpf')" oninput="validarCpf()" type="tel" id="cpf" placeholder="000.000.000-00">

                <label for="telefone">Celular / WhatsApp <strong for="telefone">*</strong></label>
                <input onblur="validarInput('telefone')" oninput="validarTelefone()" type="tel" id="telefone" placeholder="(00) 00000-0000">

                <button onclick="salvarIdentidade()">Continuar</button>

            </article>

        </section>


        <!-- ENTREGA -->
        <section class="formulario entrega">

            <div class="progresso">
                <div class="column">
                    <a>1</a>
                    <p>Informa√ß√µes <br> pessoais</p>
                </div>
                <div class="column">
                    <a class="selecionadoFundo">2</a>
                    <p class="selecionadoCor">Entrega</p>
                </div>
                <div class="column">
                    <a>3</a>
                    <p>Pagamento</p>
                </div>
            </div>

            <!-- Fomulario de Entrega -->
            <article class="form">

                <h1><span>2</span>Entrega</h1>

                <label for="cep">CEP <strong for="cep">*</strong></label>
                <input onblur="validarInput('cep')" oninput="validarCEP()" id="cep" placeholder="00000-000" type="text">

                <div class="column" id="mostrarCep">

                    <label for="estado">Estado</label>
                    <input id="estado" type="text" disabled>

                    <label for="cidade">Cidade</label>
                    <input id="cidade" type="text" disabled>

                    <label for="bairro">Bairro</label>
                    <input id="bairro" type="text" disabled>

                    <label for="rua">Rua</label>
                    <input id="rua" type="text" disabled>

                    <label for="numero">Numero <strong for="numero">*</strong></label>
                    <input onblur="validarInput('numero')" oninput="validarNumero()" id="numero" placeholder="ex: 123" type="text">

                    <label for="destinatario">Destinat√°rio <strong for="destinatario">*</strong></label>
                    <input onblur="validarInput('destinatario')" oninput="validarNumero()" id="destinatario" placeholder="ex: Vitor" type="text">

                    <label for="complemento">Complemento</label>
                    <textarea placeholder="Opcional" id="complemento"></textarea>

                </div>
                
                <h1 class="none" id="erroCEP"></h1>

                <button onclick="salvarEntrega()">Salvar</button>
                <a onclick="abrirForm('identificacao')">Voltar</a>
                
            </article>

        </section>


        <!-- PAGAMENTO -->
        <section class="formulario pagamento">

            <div class="progresso">
                <div class="column">
                    <a>1</a>
                    <p>Informa√ß√µes <br> pessoais</p>
                </div>
                <div class="column">
                    <a>2</a>
                    <p>Entrega</p>
                </div>
                <div class="column">
                    <a class="selecionadoFundo">3</a>
                    <p class="selecionadoCor">Pagamento</p>
                </div>
            </div>

            <!-- Fomulario de Entrega -->
            <article class="form">

                <h1><span>3</span>Pagamento</h1>

                <div class="titulo">
                    
                    <!-- PAGAMENTO COM PIX -->
                    <ion-icon name="cash-outline"></ion-icon>
                    <h1>Pague agora com o <strong>Pix</strong></h1>
                    <p>A confirma√ß√£o de pagamento √© realizada em poucos minutos. Utilize o aplicativo do seu banco para pagar. </p>


                </div>
                
                <!-- VALOR DO PRODUTO -->
                <label>Valor do produto</label>
                <input id="valor" type="text" disabled>

                <!-- BOT√ÉO DO WHATSAPP -->
                <button class="btn-whatsapp" onclick="whatsapp()"><ion-icon class="icon-whatsapp" name="logo-whatsapp"></ion-icon> Enviar Comprovante via Whatsapp</button>
                
                <!-- QRCODE -->
                <div class="titulo">

                    <p>Leia o <strong>QR CODE</strong> abaixo com o aplicativo do seu banco e realize o pagamento do Pix</p>
                    <img id="qrcode" src="">

                </div>
                
                <div class="ou">
                    <p>OU</p>
                </div>

                <div class="titulo">

                    <p>Copie o <strong>C√≥digo Pix</strong> abaixo e insira na op√ß√£o <strong>Pix Copia e Cola</strong> no aplicativo do seu banco para realizar o pagamento do Pix.</p>
                    <input id="codigoPix" type="text" disabled>
                    <button id="btnCopiar" class="btn-copiar">Copiar</button>
                </div>
                
                <button onclick="abrirURL('carrinho')">Ver Status da Compra</button>

            </article>

        </section>



    </main>

    <footer class="creditos">

        <p>Mv Outlet: mvoutlet.netlify.app</p>
        <p>¬© MVoutlet - CNPJ: 42.334.245/0001-24</p>

    </footer>


</body>

    <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-storage-compat.js"></script>
    <!-- JAVASCRIPT -->
    <script>

        // VALIDAR INPUT
        function validarInput(id) {
            const input = document.getElementById(id);
            const alerta = document.querySelector(`strong[for="${id}"]`);
            const dado = alerta.textContent;
            if (!input.value) {
                input.style.background = "var(--rosa)";
                input.style.boxShadow = "0px 0px 15px var(--rosa)";
                input.style.border = "2px solid var(--rosa)";
                alerta.style.fontSize = "15.5px";
                alerta.style.margin = "0px 0px 0px 3px";
                alerta.innerHTML = `Campo obrigat√≥rio`;
            } else {
                input.style.background = "#f1f1f1";
                input.style.boxShadow = "none";
                input.style.border = "2px solid #f1f1f1";
                alerta.innerHTML = ``;
            }
        }

        // TELEFONE
        function validarTelefone() {
            const inputNumero = document.getElementById("telefone");
            const numero = inputNumero.value.replace(/\D/g, '');
            const formatoTELEFONE = '($1) $2-$3';

            if (!/^\d+$/.test(numero)) {
                inputNumero.value = inputNumero.value.slice(0, inputNumero.value.length - 1);
                return;
            }

            // Adiciona par√™nteses e h√≠fen ap√≥s 11 d√≠gitos
            if (numero.length === 11) {
                inputNumero.value = numero.replace(/^(\d{2})(\d{5})(\d{4})$/, formatoTELEFONE);
            } else if (numero.length > 11) {
                inputNumero.value = inputNumero.value.slice(0, 15);
            }
        }

        // CPF
        function validarCpf() {
            const inputNumero = document.getElementById("cpf");
            const numero = inputNumero.value.replace(/\D/g, ''); // Remove n√£o d√≠gitos
            const formatoCPF = '$1.$2.$3-$4';

            const cpfRegex = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;

            if (!/^\d+$/.test(inputNumero.value)) {
                inputNumero.value = inputNumero.value.slice(0, inputNumero.value.length - 1);
                return;
            }

            // Adiciona par√™nteses e h√≠fen ap√≥s 11 d√≠gitos
            if (numero.length === 11) {
                inputNumero.value = numero.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, formatoCPF)
            } else if (numero.length > 11) {
                inputNumero.value = inputNumero.value.slice(0, 15);
            }

        }

        function validarNumero() {
            const inputNumero = document.getElementById("numero");
            const numero = inputNumero.value.replace(/\D/g, ''); // Remove n√£o d√≠gitos

            if (!/^\d+$/.test(inputNumero.value)) {
                inputNumero.value = inputNumero.value.slice(0, inputNumero.value.length - 1);
                return;
            }


        }

        async function validarCEP() {
            const inputCep = document.getElementById('cep');
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            
            if (!/^\d+$/.test(cep)) {
                inputCep.value = inputCep.value.slice(0, inputCep.value.length - 1);
                return;
            }

            if (cep.length === 8) {
                await consultarCEP(cep);
                inputCep.value = cep.replace(/^(\d{5})(\d{3})$/, "$1-$2");
            } else if (cep.length > 8) {
                inputCep.value = inputCep.value.slice(0, 8);
            }

        }

        // COPIAR ID DE RASTREAMENTO
        function copiarCodigo(id) {
            const btnCopiar = document.getElementById('btnCopiar');

            // Cria uma √°rea de transfer√™ncia tempor√°ria
            var areaTransferencia = document.createElement("textarea");

            // Define o valor da √°rea de transfer√™ncia como o texto do elemento
            areaTransferencia.value = id;
            
            // Adiciona a √°rea de transfer√™ncia ao corpo do documento
            document.body.appendChild(areaTransferencia);

            // Seleciona e copia o texto da √°rea de transfer√™ncia
            areaTransferencia.select();
            document.execCommand("copy");

            // Remove a √°rea de transfer√™ncia tempor√°ria
            document.body.removeChild(areaTransferencia);
            btnCopiar.innerHTML = 'Copiado com sucesso';
        }




        // BANCO DE DADOS
        const firebaseConfig = {
            apiKey: "AIzaSyBqbDhvZYwoJng6u2AF-YHTBBCPWiYAnuY",
            authDomain: "dropp-71540.firebaseapp.com",
            projectId: "dropp-71540",
            storageBucket: "dropp-71540.appspot.com",
            messagingSenderId: "226605796065",
            appId: "1:226605796065:web:7b6a8652ed1e93d78f45a0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        const conta = localStorage.getItem('email')
        
        const produto = getParameterByName('produto')
        if (conta) {
            db.collection('usuarios')
            .doc(conta).get().then((doc) => {
                if (doc.data()) {
                    if (produto) {
                        const inputValor = document.getElementById('valor');
                        const codigoPix = document.getElementById('codigoPix');
                        const qrcode = document.getElementById('qrcode');
                        const btnCopiar = document.getElementById('btnCopiar');
                        db.collection('produtos')
                        .doc(produto)
                        .collection('pagamentos')
                        .doc('pix')
                        .get().then((doc) => {
                            const documento = doc.data();
                            if (!documento) {
                                window.location.href = "../";
                            } else {
                                const preco = doc.data().valor;
                                const codigo = doc.data().codigoPix;
                                const imagemPix = doc.data().qrcode;
                                inputValor.value = preco;
                                codigoPix.value = codigo;
                                btnCopiar.addEventListener('click', () => {
                                    copiarCodigo(codigo);
                                });
                                const storageRef = storage.ref().child(`produtos/${produto}/${imagemPix}`); 
                                storageRef.getDownloadURL().then( function(url) {
                                    qrcode.src = url;
                                });
                                db.collection('usuarios')
                                .doc(conta)
                                .collection('compras')
                                .doc(produto).get().then((doc) => {
                                    const documento = doc.data();
                                    if (documento) {
                                        abrirForm('pagamento');
                                    }
                                })
                            }
                        });
                    } else {
                        window.location.href = "../";
                    }
                } else {
                    window.location.href = "../carrinho";
                }
            });
        } else {
            window.location.href = "../carrinho";
        }
        
        

        // TIRAR ESPACO
        function tirarEspaco(val) {
            var resultado = val;
            resultado = resultado.replace(/\s+/g, ' ');
            resultado = resultado.trim();
            return resultado;
        }

        // PEGA O PAR√ÇMETRO NA URL
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "))
        }

        function abrirForm(classe) {
            const identidade = document.querySelector('.identificacao');
            const entrega = document.querySelector('.entrega');
            const pagamento = document.querySelector('.pagamento');
            identidade.style.display = "none";
            entrega.style.display = "none";
            pagamento.style.display = "none";
            document.querySelector(`.${classe}`).style.display = "flex";
        }

        function salvarIdentidade() {
            const nome = tirarEspaco(document.getElementById('nome').value);
            const email = tirarEspaco(document.getElementById('email').value);
            const cpf = document.getElementById('cpf').value;
            const telefone = document.getElementById('telefone').value;
            const alertaNome = document.querySelector('strong[for="nome"]');
            const alertaEmail = document.querySelector('strong[for="email"]');
            const alertaCpf = document.querySelector('strong[for="cpf"]');
            const alertaTelefone = document.querySelector('strong[for="telefone"]');
            if (nome) {
                alertaNome.innerHTML = '';
                if (email) {
                    alertaNome.innerHTML = '';
                    if (cpf) {
                        alertaNome.innerHTML = '';
                        if (telefone) {
                            const cep = document.getElementById('cep').value.replace(/\D/g, '');
                            consultarCEP(cep);
                            abrirForm('entrega');
                        } else {
                            alertaTelefone.innerHTML = 'Campo obrigat√≥rio';
                            validarInput('telefone');
                        }
                    } else {
                        alertaCpf.innerHTML = 'Campo obrigat√≥rio';
                        validarInput('cpf');
                    }
                } else {
                    alertaEmail.innerHTML = 'Campo obrigat√≥rio';
                    validarInput('email');
                }
            } else {
                alertaNome.innerHTML = 'Campo obrigat√≥rio';
                validarInput('nome');
            }

            
        }

        async function salvarEntrega() {
            const cep = document.getElementById('cep').value;
            const numero = document.getElementById('numero').value;
            const destinatario = document.getElementById('destinatario').value;
            const complemento = document.getElementById('complemento').value;
            const alertaCep = document.querySelector('strong[for="cep"]');
            const alertaNumero = document.querySelector('strong[for="numero"]');
            const alertaDestinatario = document.querySelector('strong[for="destinatario"]');
            if (cep) {
                alertaCep.innerHTML = '';
                if (validarCEP(cep)) {
                    alertaCep.innerHTML = '';
                    if (numero) {
                        alertaNumero.innerHTML = 'Campo obrigat√≥rio';
                        if (destinatario) {
                            alertaDestinatario.innerHTML = 'Campo obrigat√≥rio';
                            await salvarDados();
                            abrirForm('pagamento');
                        } else {
                            alertaDestinatario.innerHTML = 'Campo obrigat√≥rio';                
                            validarInput('destinatario');
                        }
                    } else {
                        alertaNumero.innerHTML = 'Campo obrigat√≥rio';                
                       validarInput('numero');
                    }
                } else {
                    alertaCep.innerHTML = 'Cep invalido';
                    validarInput('cep');
                }
            } else {
                alertaCep.innerHTML = 'Campo obrigat√≥rio';
                validarInput('cep');
            }
        }


        // SALVAR DADOS
        function salvarDados() {
            const produto = getParameterByName('produto');
            const conta = localStorage.getItem('email')
            const nome = tirarEspaco(document.getElementById('nome').value);
            const email = tirarEspaco(document.getElementById('email').value);
            const cpf = document.getElementById('cpf').value;
            const telefone = document.getElementById('telefone').value;
            const cep = document.getElementById('cep').value;
            const numero = document.getElementById('numero').value;
            const destinatario = document.getElementById('destinatario').value;
            const complemento = document.getElementById('complemento').value;
            db.collection('usuarios')
            .doc(conta)
            .collection('compras')
            .doc(produto).set({
                nome: nome,
                email: email,
                cpf: cpf,
                telefone: telefone,
                cep: cep,
                numero: numero,
                destinatario: destinatario,
                complemento: complemento,
                status: 'Pagamento em Andamento',
                cor: 'var(--andamento)',
            }).then((response) => {
                db.collection('usuarios')
                .doc(conta)
                .collection('carrinho')
                .doc(produto).get().then((doc) => {
                    if (doc.data()) {
                        db.collection('usuarios')
                        .doc(conta)
                        .collection('carrinho')
                        .doc(produto).delete();
                    }
                });
            });
        }



        async function consultarCEP(cep) {
            const mostrarCep = document.getElementById('mostrarCep');
            const bairro = document.getElementById('bairro');
            const rua = document.getElementById('rua');
            const cidade = document.getElementById('cidade');
            const estado = document.getElementById('estado');
            const complemento = document.getElementById('complemento');
            const erroCEP = document.getElementById('erroCEP');

            // URL da API do ViaCEP
            const apiUrl = `https://viacep.com.br/ws/${cep}/json/`;

            // Fazendo requisi√ß√£o GET usando fetch
            await fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    // Verifica se a resposta da API cont√©m informa√ß√µes v√°lidas
                    if (!data.erro) {
                        validarInput('cep');
                        mostrarCep.style.display = "flex";
                        bairro.value = data.bairro;
                        rua.value = data.logradouro;
                        cidade.value = data.localidade;
                        estado.value = data.uf;
                        erroCEP.style.display = "none";
                        return true;
                    } else {
                        erroCEP.style.display = "flex";
                        erroCEP.innerHTML = 'CEP n√£o encontrado';
                        mostrarCep.style.display = "none";
                        console.error('CEP n√£o encontrado');
                        return false;
                    }
                })
                .catch(error => {
                    console.error('Erro na consulta de CEP:', error);
                });
        }

        function whatsapp() {
            window.location.href = "https://wa.me/5516997569308";
        }

        function abrirURL(url) {
            window.location.href = `../${url}`;
        }

    </script>

<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

</html>